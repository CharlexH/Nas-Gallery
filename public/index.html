<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ NAS ç›¸å†Œ</title>
    <style>
        body { margin: 0; background: #111; color: #eee; font-family: sans-serif; }
        .navbar { position: sticky; top: 0; background: #222; padding: 15px; box-shadow: 0 2px 5px #000; z-index: 10; display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-item { color: #888; cursor: pointer; }
        .nav-item:hover { color: #fff; text-decoration: underline; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 10px; }
        
        .card { 
            display: block; text-decoration: none; color: inherit;
            background: #222; border-radius: 6px; overflow: hidden; 
            transition: 0.2s; cursor: pointer; position: relative;
        }
        .card:hover { transform: translateY(-3px); background: #333; }
        
        .thumb { width: 100%; aspect-ratio: 1/1; object-fit: contain; background: #000; display: block; }
        
        /* è§†é¢‘è§’æ ‡ */
        .video-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        .placeholder { width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .name { padding: 8px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

        /* ç¯ç®±æ ·å¼è°ƒæ•´ */
        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center; }
        .lightbox.active { display: flex; }
        .lightbox img, .lightbox video { max-width: 95%; max-height: 95%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        /* å…³é—­æŒ‰é’® */
        .close-btn { 
            position: absolute; top: 20px; right: 30px; 
            color: #fff; background: rgba(255,255,255,0.2);
            width: 40px; height: 40px; border-radius: 50%;
            text-align: center; line-height: 40px; font-size: 24px;
            cursor: pointer; z-index: 101;
            transition: 0.2s;
        }
        .close-btn:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); }
    </style>
</head>
<body>
    <div class="navbar" id="nav"></div>
    <div class="grid" id="grid"></div>

    <div class="lightbox" id="lb">
        <div class="close-btn" onclick="closeLightbox()">&times;</div>
        <div id="lb-content"></div>
    </div>

    <script>
        // å…³é—­ç¯ç®±çš„å‡½æ•°
        function closeLightbox() {
            const lb = document.getElementById('lb');
            const lbCon = document.getElementById('lb-content');
            lb.classList.remove('active');
            lbCon.innerHTML = ''; // æ¸…ç©ºå†…å®¹åœæ­¢æ’­æ”¾
        }

        async function load(path = '') {
            const parts = path.split('/').filter(Boolean);
            let navHtml = `<span class="nav-item" onclick="load('')">ğŸ  é¦–é¡µ</span>`;
            let acc = '';
            parts.forEach(p => {
                acc += (acc ? '/' : '') + p;
                navHtml += ` <span>/</span> <span class="nav-item" onclick="load('${acc.replace(/'/g, "\\'")}')">${p}</span>`;
            });
            document.getElementById('nav').innerHTML = navHtml;

            const res = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
            const data = await res.json();
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            data.items.forEach(item => {
                let el, content;
                const encodedPath = encodeURIComponent(item.path);

                if (item.isDir) {
                    content = `<div class="placeholder">ğŸ“</div>`;
                } else if (item.type.startsWith('image/')) {
                    content = `<img class="thumb" src="/api/thumb?path=${encodedPath}" loading="lazy">`;
                } else if (item.type.startsWith('video/')) {
                    // æ”¹åŠ¨ï¼šè§†é¢‘ç°åœ¨ä¹Ÿè¯·æ±‚ç¼©ç•¥å›¾ï¼Œå¹¶åŠ ä¸Šè§’æ ‡
                    content = `
                        <div style="position:relative">
                            <img class="thumb" src="/api/thumb?path=${encodedPath}" loading="lazy">
                            <div class="video-badge">VIDEO</div>
                        </div>
                    `;
                } else {
                    content = `<div class="placeholder">ğŸ“„</div>`;
                }

                if (item.isDir) {
                    el = document.createElement('div');
                    el.onclick = () => load(item.path);
                } else {
                    el = document.createElement('a');
                    el.href = `/api/raw?path=${encodedPath}`;
                    el.onclick = (e) => {
                        if (!e.ctrlKey && !e.metaKey && e.button === 0) {
                            e.preventDefault();
                            const lb = document.getElementById('lb');
                            const lbCon = document.getElementById('lb-content');
                            lb.classList.add('active');
                            if(item.type.startsWith('video/')) {
                                // è‡ªåŠ¨æ’­æ”¾
                                lbCon.innerHTML = `<video src="${el.href}" controls autoplay style="max-width:90vw; max-height:90vh"></video>`;
                            } else {
                                lbCon.innerHTML = `<img src="${el.href}">`;
                            }
                        }
                    };
                }
                
                el.className = 'card';
                el.innerHTML = `${content}<div class="name">${item.name}</div>`;
                grid.appendChild(el);
            });
        }
        load();
    </script>
</body>
</html>