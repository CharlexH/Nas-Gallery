<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ NAS ç›¸å†Œ</title>
    <style>
        body { margin: 0; background: #111; color: #eee; font-family: sans-serif; }
        .navbar { position: sticky; top: 0; background: #222; padding: 15px; box-shadow: 0 2px 5px #000; z-index: 10; display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-item { color: #888; cursor: pointer; }
        .nav-item:hover { color: #fff; text-decoration: underline; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 10px; }
        
        .card { 
            display: block; text-decoration: none; color: inherit;
            background: #222; border-radius: 6px; overflow: hidden; 
            transition: 0.2s; cursor: pointer; position: relative;
        }
        .card:hover { transform: translateY(-3px); background: #333; }
        
        .thumb { width: 100%; aspect-ratio: 1/1; object-fit: contain; background: #000; display: block; }
        
        /* è§†é¢‘è§’æ ‡ */
        .video-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        .placeholder { width: 100%; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        .name { padding: 8px; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }

        /* ç¯ç®±æ ·å¼è°ƒæ•´ */
        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center; }
        .lightbox.active { display: flex; }
        .lightbox img, .lightbox video { max-width: 95%; max-height: 95%; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        /* å…³é—­æŒ‰é’® */
        .close-btn { 
            position: absolute; top: 20px; right: 30px; 
            color: #fff; background: rgba(255,255,255,0.2);
            width: 40px; height: 40px; border-radius: 50%;
            text-align: center; line-height: 40px; font-size: 24px;
            cursor: pointer; z-index: 101;
            transition: 0.2s;
        }
        .close-btn:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); }
    </style>
</head>
<body>
    <div class="navbar" id="nav"></div>
    <div class="grid" id="grid"></div>

    <div class="lightbox" id="lb">
        <div class="close-btn" onclick="closeLightbox()">&times;</div>
        <div id="lb-content"></div>
    </div>

    <script>
        // --- 1. å°è£…æœ¬åœ°å­˜å‚¨å·¥å…· (æ–°å¢éƒ¨åˆ†) ---
        const LocalCache = {
            //ä»¥æ­¤å‰ç¼€å¼€å¤´ï¼Œé˜²æ­¢è·Ÿå…¶ä»–åº”ç”¨å†²çª
            prefix: 'nas_gallery_', 
            
            get(path) {
                try {
                    const item = localStorage.getItem(this.prefix + path);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    console.warn('è¯»å–ç¼“å­˜å¤±è´¥', e);
                    return null;
                }
            },
            
            set(path, data) {
                try {
                    // å°†å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²å­˜å…¥æµè§ˆå™¨æœ¬åœ°æ•°æ®åº“
                    localStorage.setItem(this.prefix + path, JSON.stringify(data));
                } catch (e) {
                    // å¦‚æœç¼“å­˜æ»¡äº†(é€šå¸¸5MB)ï¼Œç®€å•ç²—æš´åœ°æ¸…ç©ºä¸€ä¸‹ï¼Œä¿è¯æ–°æ•°æ®èƒ½å­˜å…¥
                    console.warn('ç¼“å­˜å·²æ»¡ï¼Œæ‰§è¡Œæ¸…ç†');
                    localStorage.clear();
                }
            }
        };

        // --- 2. ç¯ç®±æ§åˆ¶ (ä¿æŒä¸å˜) ---
        function closeLightbox() {
            const lb = document.getElementById('lb');
            const lbCon = document.getElementById('lb-content');
            lb.classList.remove('active');
            lbCon.innerHTML = ''; 
        }

        // --- 3. æ¸²æŸ“ç•Œé¢ (ä¿æŒä¸å˜) ---
        function render(path, data) {
            const parts = path.split('/').filter(Boolean);
            let navHtml = `<span class="nav-item" onclick="navigateTo('')">ğŸ  é¦–é¡µ</span>`;
            let acc = '';
            parts.forEach(p => {
                acc += (acc ? '/' : '') + p;
                navHtml += ` <span>/</span> <span class="nav-item" onclick="navigateTo('${acc.replace(/'/g, "\\'")}')">${p}</span>`;
            });
            document.getElementById('nav').innerHTML = navHtml;

            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            data.items.forEach(item => {
                let el, content;
                const encodedPath = encodeURIComponent(item.path);

                if (item.isDir) {
                    content = `<div class="placeholder">ğŸ“</div>`;
                } else if (item.type.startsWith('image/')) {
                    content = `<img class="thumb" src="/api/thumb?path=${encodedPath}" loading="lazy">`;
                } else if (item.type.startsWith('video/')) {
                    content = `
                        <div style="position:relative">
                            <img class="thumb" src="/api/thumb?path=${encodedPath}" loading="lazy">
                            <div class="video-badge">VIDEO</div>
                        </div>
                    `;
                } else {
                    content = `<div class="placeholder">ğŸ“„</div>`;
                }

                if (item.isDir) {
                    el = document.createElement('div');
                    el.onclick = () => navigateTo(item.path);
                } else {
                    el = document.createElement('a');
                    el.href = `/api/raw?path=${encodedPath}`;
                    el.onclick = (e) => {
                        if (!e.ctrlKey && !e.metaKey && e.button === 0) {
                            e.preventDefault();
                            const lb = document.getElementById('lb');
                            const lbCon = document.getElementById('lb-content');
                            lb.classList.add('active');
                            if(item.type.startsWith('video/')) {
                                lbCon.innerHTML = `<video src="${el.href}" controls autoplay style="max-width:90vw; max-height:90vh"></video>`;
                            } else {
                                lbCon.innerHTML = `<img src="${el.href}">`;
                            }
                        }
                    };
                }
                
                el.className = 'card';
                el.innerHTML = `${content}<div class="name">${item.name}</div>`;
                grid.appendChild(el);
            });
        }

        // --- 4. æ ¸å¿ƒï¼šè·å–æ•°æ® (SWR + LocalStorage) ---
        async function fetchAndRender(path) {
            // A. ä¼˜å…ˆä»æµè§ˆå™¨æœ¬åœ°æ•°æ®åº“è¯»å–
            const cachedData = LocalCache.get(path);

            // å¦‚æœæœ¬åœ°æœ‰ï¼Œç«‹åˆ»æ¸²æŸ“ï¼ˆå³ä½¿æ–­ç½‘ä¹Ÿèƒ½çœ‹åˆ°æ—§åˆ—è¡¨ï¼‰
            if (cachedData) {
                console.log(`âš¡ï¸ [Local] å‘½ä¸­ç¼“å­˜: ${path || 'root'}`);
                render(path, cachedData);
            }

            // B. åå°é™é»˜å‘èµ·ç½‘ç»œè¯·æ±‚
            try {
                const res = await fetch(`/api/browse?path=${encodeURIComponent(path)}`);
                const newData = await res.json();
                
                // C. å¯¹æ¯”æ•°æ®ï¼šå¦‚æœä¸ä¸€è‡´ï¼Œæ›´æ–°ç•Œé¢å¹¶å†™å…¥æœ¬åœ°å­˜å‚¨
                if (!cachedData || JSON.stringify(cachedData) !== JSON.stringify(newData)) {
                    console.log(`ğŸ”„ [Network] æ•°æ®æ›´æ–°: ${path || 'root'}`);
                    LocalCache.set(path, newData); // å†™å…¥ LocalStorage
                    render(path, newData);
                }
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥ï¼Œå¯èƒ½ç½‘ç»œä¸­æ–­:', err);
                // å¦‚æœæœ¬åœ°ä¹Ÿæ²¡æ•°æ®ï¼Œç½‘ç»œä¹ŸæŒ‚äº†ï¼Œæ‰æ˜¾ç¤ºé”™è¯¯
                if (!cachedData) {
                    document.getElementById('grid').innerHTML = '<div style="padding:20px;color:#888">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>';
                }
            }
        }

        // --- 5. å¯¼èˆªä¸åˆå§‹åŒ– (ä¿æŒä¸å˜) ---
        function navigateTo(path) {
            const url = path ? `?path=${encodeURIComponent(path)}` : window.location.pathname;
            history.pushState({ path: path }, '', url);
            fetchAndRender(path);
        }

        window.onpopstate = (event) => {
            const path = event.state ? event.state.path : '';
            fetchAndRender(path);
        };

        (function init() {
            const params = new URLSearchParams(window.location.search);
            const currentPath = params.get('path') || '';
            history.replaceState({ path: currentPath }, '', window.location.href);
            fetchAndRender(currentPath);
        })();
    </script>
</body>
</html>